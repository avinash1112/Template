# Location rules for static assets
# Included in HTTPS server block

# Security headers (safe defaults)
add_header X-Content-Type-Options nosniff always;
add_header X-Frame-Options SAMEORIGIN always;
add_header Referrer-Policy strict-origin-when-cross-origin always;

# Don't list directories
autoindex off;

# Symlink safety
disable_symlinks if_not_owner from=/var/www/html;

# Block hidden files and sensitive stuff
location ~ /\.(?!well-known) { deny all; }

# 1) Hashed JS/CSS emitted by Vite (filename.[hash].ext) → long, immutable cache
location ~* ^/assets/.+\.[0-9a-f]{8,}\.(?:js|mjs|css)$ {
  access_log off;
  expires 1y;
  add_header Cache-Control "public, max-age=31536000, immutable";
  try_files $uri =404;
}

# 2) Fonts / images / media → medium cache
location ~* \.(?:png|jpe?g|gif|webp|avif|ico|svg|woff2?|ttf|eot)$ {
  access_log off;
  expires 30d;
  add_header Cache-Control "public, max-age=2592000";
  try_files $uri =404;
}

# 3) Service worker & manifest must update promptly
location = /service-worker.js {
  add_header Cache-Control "no-cache, no-store, must-revalidate";
  expires -1;
  try_files $uri =404;
}
location = /manifest.webmanifest {
  add_header Cache-Control "no-cache, no-store, must-revalidate";
  expires -1;
  try_files $uri =404;
}

# 4) HTML (including index.html) → no-cache
location ~* \.html$ {
  add_header Cache-Control "no-cache, no-store, must-revalidate";
  expires -1;
  try_files $uri =404;
}

# SPA fallback - Real files (assets) 404 correctly; unknown paths fall back to index.html
location / {
  try_files $uri $uri/ /index.html;
}

# Methods: static sites typically only need GET/HEAD/OPTIONS
if ($request_method !~ ^(GET|HEAD|OPTIONS)$) { return 405; }